# Sonar Sentry Daemonset

This repository contains the necessary files to deploy a Sonar Sentry Daemonset using Helm and Docker.

## Directory Structure

- `container/`: Contains the Dockerfile and scripts for building the Docker image.
- `helm/`: Contains the Helm chart for deploying the Sonar Sentry Daemonset.

## How to Use

### Prerequisites

- Docker
- Kubernetes
- Helm

### Steps

1. Clone this repository

    ```sh
    git clone https://github.com/logpresso/sonar-sentry-daemonset
    ```

2. Build the Docker image:

    ```sh
    pushd container && ./build.sh && popd
    docker images | grep -i sonar-sentry
    ```

3. Register the Docker image(sonar-sentry:latest) to your Kubernetes container registry.

4. Edit the values.yaml file in the helm/ directory to configure the environment for your new sentry.

    - GUID: Identifier used when adding Sonar Sentry.
    - AUTH_TOKEN: Auth Token generated by Sonar when adding Sonar Sentry. (`XXXX-XXXX`)
    - DEPLOY_URL: Endpoint URL used by the Sonar Sentry Deployment module. (ex: `https://host.docker.internal:44300`)
    - BASE_ADDR: String representing the IP:Port format that Sonar Sentry will connect to. (ex: `host.docker.internal`)

5. Install the Helm chart:

    ```sh
    helm install sonar-sentry helm/
    ```

### Diagnostics
You can execute commands in the Sonar Sentry pod using kubectl exec. For example:

```sh
kubectl exec -it `kubectl get pods -o name | grep -i sonar-sentry` -- /bin/bash
```

### Uninstall
To uninstall the Helm chart, run:

```sh
helm uninstall sonar-sentry
```

### Testing
You can use the Rocky 9 Pod for testing:

```sh
kubectl apply -f helm/rocky-pod.yaml
kubectl get pods
kubectl exec -it rocky-test-pod -- /bin/bash
```

Then, you can send a test syslog message:
```sh
echo "<14>Syslog for testing" | nc -u sonar-sentry 514
```
